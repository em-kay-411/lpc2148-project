#include "lpc214x.h"
#include "SPI.h"
#include "card.h"
#include "interrupts.h"
#include "uart.h"
#include "stdio.h"
#include "stdlib.h"
#include "kernel.h"


void (*kernel_entry_point)();
unsigned char kernelMemory[228];

unsigned char kernelHexData[] = {0x20, 0x00, 0x00, 0xEA, 0x00, 0x00, 0xA0, 0xE1, 0x7C, 0x00, 0x9F, 0xE5, 0x14, 0x00, 0xD0, 0xE5, 0x01, 0x00, 0x00, 0xE2, 0x00, 0x00, 0x50, 0xE3, 0xFA, 0xFF, 0xFF, 0x0A, 0x68, 0x00, 0x9F, 0xE5, 0x00, 0x00,
																 0xD0, 0xE5, 0x64, 0x10, 0x9F, 0xE5, 0x00, 0x00, 0xC1, 0xE5, 0x00, 0x00, 0x81, 0xE2, 0x00, 0x00, 0xD0, 0xE5, 0x0A, 0x00, 0x50, 0xE3, 0x08, 0x00, 0x00, 0x1A, 0x00, 0x00, 0xA0, 0xE1, 0x44, 0x00, 0x9F, 0xE5,
																 0x14, 0x00, 0xD0, 0xE5, 0x20, 0x00, 0x00, 0xE2, 0x00, 0x00, 0x50, 0xE3, 0xFA, 0xFF, 0xFF, 0x0A, 0x0D, 0x00, 0xA0, 0xE3, 0x2C, 0x10, 0x9F, 0xE5, 0x00, 0x00, 0xC1, 0xE5, 0x00, 0x00, 0xA0, 0xE1, 0x20, 0x00,
																 0x9F, 0xE5, 0x14, 0x00, 0xD0, 0xE5, 0x20, 0x00, 0x00, 0xE2, 0x00, 0x00, 0x50, 0xE3, 0xFA, 0xFF, 0xFF, 0x0A, 0x10, 0x00, 0x9F, 0xE5, 0x00, 0x00, 0xD0, 0xE5, 0x04, 0x10, 0x9F, 0xE5, 0x00, 0x00, 0xC1, 0xE5,
																 0xDD, 0xFF, 0xFF, 0xEA, 0x00, 0xC0, 0x00, 0xE0, 0x08, 0x00, 0x00, 0x40, 0x96, 0x0D, 0xA0, 0xE3, 0x9B, 0xFF, 0xFF, 0xEB, 0x40, 0x00, 0x8F, 0xE2, 0x7F, 0xFE, 0xFF, 0xEB, 0x40, 0x00, 0x8F, 0xE2, 0x7D, 0xFE,
																 0xFF, 0xEB, 0xBB, 0xFF, 0xFF, 0xEB, 0x50, 0x00, 0x9F, 0xE5, 0x50, 0x10, 0x9F, 0xE5, 0x00, 0x00, 0x81, 0xE5, 0x4C, 0x00, 0x8F, 0xE2, 0x77, 0xFE, 0xFF, 0xEB, 0x5C, 0x00, 0x8F, 0xE2, 0x75, 0xFE, 0xFF, 0xEB,
																 0x38, 0x00, 0x9F, 0xE5, 0x00, 0x00, 0x90, 0xE5, 0x0F, 0xE0, 0xA0, 0xE1, 0x10, 0xFF, 0x2F, 0xE1, 0x00, 0x00, 0xA0, 0xE1, 0xFE, 0xFF, 0xFF, 0xEA};

void switchToUserMode(){
	unsigned int cpsrValue;
	
	__asm {
		MRS cpsrValue, CPSR
	}
	
	cpsrValue &= 0xFFFFFFF0;
	
	__asm {
		MSR CPSR_cxsf, cpsrValue
	}
}

int main(){		
	
	UartInit(9600);		 							//Initialize UART with 9600 baudrate
	printf("\nHello\n");
	printf("Program for MicroSD card\n\n");  
	
	card_init(); // Initialise card
	enable_interrupts();	
	
	
	load_kernel(0x00, kernelMemory);	
	
	
	
	//load_kernel_safe(kernelHexData, kernelMemory, kernelSize);
	kernel_entry_point = (void (*)())kernelMemory;	
	//kernel_entry_point = kernelHexData;	
	printf("Declared entry point\n\n");
	printf("Welcome to the Kernel! Type from your keyboard to display.\n\n");
	kernel_entry_point();
	
	
	// Halt
	while(1);
}
